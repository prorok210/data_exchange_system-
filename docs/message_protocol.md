# Протокол MAVLink для обмена сообщениями

Данный документ описывает использование протокола MAVLink для обмена данными между устройствами в системе.

## Общая информация о MAVLink

MAVLink (Micro Air Vehicle Link) - это легковесный протокол для коммуникации между беспилотными летательными аппаратами (и другими транспортными средствами) и наземными станциями управления. В нашей системе MAVLink используется для передачи телеметрии, команд и статусных сообщений между устройствами ESP32 и другими компонентами системы.

### Основные характеристики протокола:

- **Версия:** MAVLink 2.0
- **Минимальный размер пакета:** 11 байт
- **Максимальный размер пакета:** 280 байт
- **Проверка целостности:** CRC_EXTRA (CRC-16/MCRF4XX)
- **Поддержка подписи:** Да (в MAVLink 2.0)
- **Идентификация отправителя/получателя:** System ID и Component ID

## Структура сообщения MAVLink

Каждое сообщение MAVLink 2.0 имеет следующую структуру:

| Поле | Размер (байт) | Описание |
|------|--------------|----------|
| Маркер начала | 1 | 0xFD для MAVLink 2.0 |
| Длина полезной нагрузки | 1 | Длина данных (не включая заголовок) |
| Incompatibility флаги | 1 | Флаги несовместимости |
| Compatibility флаги | 1 | Флаги совместимости |
| Sequence number | 1 | Порядковый номер пакета (0-255) |
| System ID | 1 | ID системы-отправителя (1-255) |
| Component ID | 1 | ID компонента-отправителя (0-255) |
| Message ID | 3 | ID типа сообщения (0-16777215) |
| Полезная нагрузка | до 255 | Данные сообщения (зависит от Message ID) |
| CRC | 2 | Контрольная сумма для проверки целостности |
| Подпись (опционально) | 13 | Только для подписанных сообщений |

Общий размер заголовка составляет 10 байт, к которым добавляются данные сообщения и CRC.

## Используемые сообщения MAVLink

В данной системе используются следующие типы сообщений MAVLink:

### 1. HEARTBEAT (ID: 0)
Периодическое сообщение для подтверждения активности узла и передачи его базового статуса.

**Ключевые поля:**
- `type`: Тип системы (например, MAV_TYPE_QUADROTOR)
- `autopilot`: Тип автопилота (например, MAV_AUTOPILOT_GENERIC)
- `base_mode`: Базовый режим работы
- `custom_mode`: Пользовательский режим работы
- `system_status`: Текущий статус системы

### 2. ATTITUDE (ID: 30)
Содержит информацию об ориентации устройства в пространстве.

**Ключевые поля:**
- `time_boot_ms`: Время с момента загрузки системы в мс
- `roll`: Крен в радианах (-π..+π)
- `pitch`: Тангаж в радианах (-π/2..+π/2)
- `yaw`: Рысканье в радианах (-π..+π)
- `rollspeed`, `pitchspeed`, `yawspeed`: Угловые скорости в рад/с

### 3. GLOBAL_POSITION_INT (ID: 33)
Содержит данные о географическом положении и высоте устройства.

**Ключевые поля:**
- `lat`: Широта в градусах * 10^7
- `lon`: Долгота в градусах * 10^7
- `alt`: Абсолютная высота в миллиметрах
- `relative_alt`: Относительная высота в миллиметрах
- `vx`, `vy`, `vz`: Скорости по осям в см/с
- `hdg`: Направление в градусах * 100 (0..35999)

### 4. BATTERY_STATUS (ID: 147)
Информация о состоянии батареи.

**Ключевые поля:**
- `battery_remaining`: Оставшийся заряд в процентах (0-100)
- `voltages`: Напряжение батареи в мВ
- `current_battery`: Ток в 10*мА

### 5. SYS_STATUS (ID: 1)
Общая информация о состоянии системы.

**Ключевые поля:**
- `onboard_control_sensors_present`: Битовая маска датчиков
- `load`: Загрузка процессора (0-1000)
- `voltage_battery`: Напряжение батареи в мВ
- `current_battery`: Ток батареи в 10*мА
- `battery_remaining`: Оставшийся заряд в процентах (0-100)

## Расширение системы

Для добавления поддержки новых типов сообщений MAVLink необходимо:

1. Добавить соответствующие обработчики в функцию `mavlink_parse_message()` в файле `mavlink_parser.c`
2. Создать функции подготовки таких сообщений по аналогии с существующими в `mavlink_handler.c`
3. Обновить заголовочный файл `mavlink_handler.h` новыми прототипами функций

Более подробную информацию о доступных типах сообщений MAVLink и их структуре можно найти в [официальной документации MAVLink](https://mavlink.io/).
