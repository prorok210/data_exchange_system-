# Протокол обмена сообщениями

Данный документ описывает формат сообщений, используемый для обмена данными между устройствами в системе.

## Общая информация

Протокол использует бинарные сообщения фиксированной структуры, обрамленные специальными маркерами для обеспечения надежной передачи данных по последовательному интерфейсу. Размер полезной нагрузки составляет 67 байт, что включает 65 байт данных и 2 байта контрольной суммы.

### Маркеры пакетов

Для выделения сообщений в потоке данных используются специальные маркеры:

- **Маркер начала**: `0xAA 0x55` (2 байта)
- **Маркер конца**: `0x55 0xAA` (2 байта)

Эти маркеры позволяют четко определять границы сообщений, даже если они передаются через каналы, которые могут вносить шум или разрывы в поток данных.

## Структура сообщения

Сообщение имеет следующие компоненты:

1. **Маркер начала** (2 байта)
2. **Данные** (65 байт) - структура `drone_message_t`
3. **Контрольная сумма** (2 байта) - включена как часть структуры
4. **Маркер конца** (2 байта)

Общий размер пакета с учетом маркеров составляет 71 байт.

### Детальная структура данных (drone_message_t)

Ниже приведена полная спецификация структуры сообщения с указанием типов данных, смещений и размеров каждого поля.

| № | Поле | Тип данных | Размер (байт) | Смещение | Описание |
|---|------|------------|---------------|----------|----------|
| 1 | `msg_type` | `uint8_t` | 1 | 0 | Тип сообщения (1=телеметрия, 2=команда, 3=подтверждение, 4=тревога) |
| 2 | `msg_id` | `uint8_t` | 1 | 1 | ID сообщения для подтверждений |
| 3 | `timestamp` | `uint32_t` | 4 | 2 | Временная метка (мс с момента включения) |
| 4 | `latitude` | `float` | 4 | 6 | Широта в градусах |
| 5 | `longitude` | `float` | 4 | 10 | Долгота в градусах |
| 6 | `altitude` | `float` | 4 | 14 | Высота в метрах |
| 7 | `relative_altitude` | `float` | 4 | 18 | Относительная высота от точки взлета в метрах |
| 8 | `roll` | `float` | 4 | 22 | Крен в градусах |
| 9 | `pitch` | `float` | 4 | 26 | Тангаж в градусах |
| 10 | `yaw` | `float` | 4 | 30 | Рысканье (курс) в градусах |
| 11 | `vx` | `float` | 4 | 34 | Скорость по оси X в м/с |
| 12 | `vy` | `float` | 4 | 38 | Скорость по оси Y в м/с |
| 13 | `vz` | `float` | 4 | 42 | Скорость по оси Z в м/с |
| 14 | `battery_percentage` | `uint8_t` | 1 | 46 | Процент заряда батареи (0-100) |
| 15 | `battery_voltage` | `float` | 4 | 47 | Напряжение батареи в вольтах |
| 16 | `battery_current` | `float` | 4 | 51 | Ток потребления в амперах |
| 17 | `flight_time` | `uint16_t` | 2 | 55 | Время полета в секундах |
| 18 | `status_flags` | `uint16_t` | 2 | 57 | Флаги состояния дрона |
| 19 | `cpu_load` | `uint8_t` | 1 | 59 | Загрузка процессора в процентах |
| 20 | `rssi` | `uint8_t` | 1 | 60 | Уровень сигнала в процентах |
| 21 | `satellites` | `uint8_t` | 1 | 61 | Количество спутников GPS |
| 22 | `fix_type` | `uint8_t` | 1 | 62 | Тип GPS-фиксации (0=нет, 1=2D, 2=3D) |
| 23 | `version` | `uint8_t` | 1 | 63 | Версия формата сообщения |
| 24 | `reserved` | `uint8_t` | 1 | 64 | Зарезервировано (выравнивание) |
| 25 | `checksum` | `uint16_t` | 2 | 65 | Контрольная сумма |

**Общий размер структуры:** 67 байт

## Типы сообщений

| Значение | Константа | Описание |
|----------|-----------|----------|
| 0x01 | `MSG_TYPE_TELEMETRY` | Телеметрия - данные о состоянии дрона |
| 0x02 | `MSG_TYPE_COMMAND` | Команда - инструкция для дрона |
| 0x03 | `MSG_TYPE_ACK` | Подтверждение - подтверждение получения команды |
| 0x04 | `MSG_TYPE_ALERT` | Тревога - уведомление о критической ситуации |

## Флаги статуса

Поле `status_flags` содержит битовые флаги, указывающие на различные состояния дрона:

| Бит | Константа | Описание |
|-----|-----------|----------|
| 0 | `DRONE_FLAG_ARMED` | Дрон активирован |
| 1 | `DRONE_FLAG_FLYING` | Дрон в полете |
| 2 | `DRONE_FLAG_GPS_FIX` | GPS фиксация получена |
| 3 | `DRONE_FLAG_LOW_BATTERY` | Низкий заряд батареи |
| 4 | `DRONE_FLAG_RTH_ACTIVE` | Активен режим "Возврат домой" |
| 5 | `DRONE_FLAG_FAILSAFE` | Активен режим "Аварийная защита" |
| 6 | `DRONE_FLAG_CALIBRATING` | Идет калибровка датчиков |
| 7 | `DRONE_FLAG_ERROR` | Наличие ошибки |
| 8-15 | - | Зарезервированы для будущих применений |

## Алгоритм контрольной суммы

Контрольная сумма вычисляется как простая сумма (без переноса) всех байт полезной нагрузки (все поля структуры drone_message_t, кроме самой контрольной суммы). Она используется для проверки целостности данных.
